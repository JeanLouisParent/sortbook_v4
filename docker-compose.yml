version: '3.8'
services:
  traefik:
    container_name: sortbook_traefik
    image: traefik:2.10
    restart: unless-stopped
    command:
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entryPoints.web.address=:80
      - --entryPoints.websecure.address=:443
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080" # traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /data/traefik:/data
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
    networks:
      - sortbook_net

  # Base databases
  mongo:
    container_name: sortbook_mongo
    image: mongo:6
    restart: unless-stopped
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
      - MONGO_INITDB_DATABASE=${MONGO_DB}
    volumes:
      - ./data/mongo:/data/db
    networks:
      - sortbook_net

  postgres:
    container_name: sortbook_postgres
    image: postgres:15
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      - sortbook_net

  sqlite:
    container_name: sortbook_sqlite
    build: ./services/sqlite
    restart: unless-stopped
    volumes:
      - ./data:/data
      - "${EPUB_ROOT}:/epub_root"
    networks:
      - sortbook_net

  n8n:
    container_name: sortbook_n8n
    image: n8nio/n8n:latest
    restart: unless-stopped
    environment:
      - OLLAMA_URL=${OLLAMA_URL}
      - EPUB_ROOT=${EPUB_ROOT}
      - LOG_DIR=${LOG_DIR}
      # n8n uses the mounted /data by default (SQLite). Keep as-is.
    volumes:
      - ./data:/data
      - "${EPUB_ROOT}:/epub_root"
      - ./workflow:/workflow
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=PathPrefix(`/n8n`)"
      - "traefik.http.routers.n8n.entrypoints=web"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
      - "traefik.http.middlewares.n8n-strip.stripprefix.prefixes=/n8n"
      - "traefik.http.routers.n8n.middlewares=n8n-strip"
    networks:
      - sortbook_net

  flowise:
    container_name: sortbook_flowise
    image: flowiseai/flowise:latest
    restart: unless-stopped
    environment:
      - OLLAMA_URL=${OLLAMA_URL}
      - EPUB_ROOT=${EPUB_ROOT}
      - LOG_DIR=${LOG_DIR}
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
      - MONGO_DB=${MONGO_DB}
      - MONGODB_URI=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongo:27017/${MONGO_DB}?authSource=admin
      - MONGO_URL=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongo:27017/${MONGO_DB}?authSource=admin
    volumes:
      - ./data:/data
      - "${EPUB_ROOT}:/epub_root"
      - ./workflow:/workflow
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.flowise.rule=PathPrefix(`/flowise`)"
      - "traefik.http.routers.flowise.entrypoints=web"
      - "traefik.http.services.flowise.loadbalancer.server.port=3000"
      - "traefik.http.middlewares.flowise-strip.stripprefix.prefixes=/flowise"
      - "traefik.http.routers.flowise.middlewares=flowise-strip"
    depends_on:
      - mongo
    networks:
      - sortbook_net

  windmill_server:
    container_name: sortbook_windmill_server
    image: ghcr.io/windmill-labs/windmill:latest
    restart: unless-stopped
    environment:
      - MODE=server
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      - BASE_URL=http://localhost
      - OLLAMA_URL=${OLLAMA_URL}
      - EPUB_ROOT=${EPUB_ROOT}
      - LOG_DIR=${LOG_DIR}
    volumes:
      - ./data:/data
      - "${EPUB_ROOT}:/epub_root"
      - ./workflow:/workflow
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.windmill.rule=PathPrefix(`/windmill`)"
      - "traefik.http.routers.windmill.entrypoints=web"
      - "traefik.http.services.windmill.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.windmill-strip.stripprefix.prefixes=/windmill"
      - "traefik.http.routers.windmill.middlewares=windmill-strip"
    depends_on:
      - postgres
    networks:
      - sortbook_net

  windmill_worker:
    container_name: sortbook_windmill_worker
    image: ghcr.io/windmill-labs/windmill:latest
    restart: unless-stopped
    environment:
      - MODE=worker
      - WORKER_GROUP=default
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      - OLLAMA_URL=${OLLAMA_URL}
      - EPUB_ROOT=${EPUB_ROOT}
      - LOG_DIR=${LOG_DIR}
    volumes:
      - ./data:/data
      - "${EPUB_ROOT}:/epub_root"
      - ./workflow:/workflow
    depends_on:
      - postgres
    networks:
      - sortbook_net

networks:
  sortbook_net:
    driver: bridge
